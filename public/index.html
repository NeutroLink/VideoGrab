<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoGrab - Universal Video Downloader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
            text-align: center;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .url-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .url-input.checking {
            border-color: #ffa500;
        }

        .url-input.valid {
            border-color: #28a745;
        }

        .url-input.invalid {
            border-color: #dc3545;
        }

        .input-status {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .video-preview {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .video-preview.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .video-preview-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            text-align: left;
        }

        .video-thumbnail {
            min-width: 160px;
            width: 160px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .video-details {
            flex: 1;
        }

        .video-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .video-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .meta-icon {
            width: 16px;
            height: 16px;
        }

        .format-select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            background: white;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .format-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .quality-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .quality-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .quality-option:hover:not(.disabled) {
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .quality-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .quality-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .quality-option.disabled::after {
            content: "Not Available";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .download-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .download-btn.processing {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s ease;
        }

        .download-btn:hover::before {
            left: 100%;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.3) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.3) 75%, transparent 75%);
            background-size: 20px 20px;
            animation: progressAnimation 1s linear infinite;
        }

        @keyframes progressAnimation {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        .status-text {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .error-message {
            background: #ffe6e6;
            border: 1px solid #ffcccc;
            color: #cc0000;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .success-message {
            background: #e6ffe6;
            border: 1px solid #ccffcc;
            color: #006600;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .file-size-estimate {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            display: none;
        }

        .supported-sites {
            margin-top: 30px;
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }

        .supported-sites h3 {
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }

        .supported-sites p {
            text-align: center;
            margin-bottom: 15px;
        }

        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .site-tag {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .site-tag:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .platform-icon {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .recently-downloaded {
            margin-top: 25px;
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            display: none;
        }

        .recently-downloaded.show {
            display: block;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .recent-thumbnail {
            width: 60px;
            height: 34px;
            object-fit: cover;
            border-radius: 4px;
        }

        .recent-details {
            flex: 1;
        }

        .recent-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .recent-meta {
            font-size: 12px;
            color: #666;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .video-preview-content {
                flex-direction: column;
                text-align: center;
            }
            
            .video-thumbnail {
                width: 200px;
                height: 112px;
                align-self: center;
            }
            
            .quality-group {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .quality-option {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">VideoGrab</div>
        <div class="subtitle">Download videos from any platform</div>
        
        <form id="downloadForm">
            <div class="input-group">
                <input type="url" class="url-input" id="videoUrl" 
                       placeholder="Paste video URL here (YouTube, TikTok, Instagram, etc.)" 
                       required>
                <span class="input-status" id="inputStatus"></span>
            </div>
            
            <div class="video-preview" id="videoPreview">
                <div class="video-preview-content">
                    <img class="video-thumbnail" id="videoThumbnail" alt="Video thumbnail">
                    <div class="video-details">
                        <div class="video-title" id="videoTitle"></div>
                        <div class="video-meta">
                            <div class="meta-item">
                                <span class="meta-icon">‚è±Ô∏è</span>
                                <span id="videoDuration"></span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">üë§</span>
                                <span id="videoUploader"></span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">üìè</span>
                                <span id="videoSize"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <select class="format-select" id="formatSelect">
                <option value="mp4">üìπ MP4 Video (Best compatibility)</option>
                <option value="mp3">üéµ MP3 Audio (High quality)</option>
                <option value="webm">üé¨ WebM Video (Smaller size)</option>
                <option value="m4a">üéº M4A Audio (Apple compatible)</option>
            </select>
            
            <div class="quality-group" id="qualityGroup">
                <div class="quality-option tooltip" data-quality="4320p" data-tooltip="8K Ultra HD - Premium quality">
                    <strong>8K Ultra HD</strong><br>
                    <small>7680x4320</small>
                </div>
                <div class="quality-option tooltip" data-quality="2160p" data-tooltip="4K Ultra HD - Excellent quality">
                    <strong>4K Ultra HD</strong><br>
                    <small>3840x2160</small>
                </div>
                <div class="quality-option tooltip" data-quality="1440p" data-tooltip="1440p QHD - Great quality">
                    <strong>1440p QHD</strong><br>
                    <small>2560x1440</small>
                </div>
                <div class="quality-option selected tooltip" data-quality="1080p" data-tooltip="1080p Full HD - Recommended">
                    <strong>1080p Full HD</strong><br>
                    <small>1920x1080</small>
                </div>
                <div class="quality-option tooltip" data-quality="720p" data-tooltip="720p HD - Good quality">
                    <strong>720p HD</strong><br>
                    <small>1280x720</small>
                </div>
                <div class="quality-option tooltip" data-quality="480p" data-tooltip="480p SD - Smaller files">
                    <strong>480p SD</strong><br>
                    <small>854x480</small>
                </div>
            </div>

            <div class="file-size-estimate" id="fileSizeEstimate">
                üíæ Estimated file size: <span id="estimatedSize"></span>
            </div>
            
            <button type="submit" class="download-btn" id="downloadBtn" disabled>
                <span id="downloadText">Enter URL to continue</span>
            </button>
        </form>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-text" id="statusText">Initializing download...</div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <div class="recently-downloaded" id="recentlyDownloaded">
            <h3>üì• Recent Downloads</h3>
            <div id="recentList"></div>
        </div>
        
        <div class="supported-sites">
            <h3>Supported Platforms</h3>
            <p>Download from 1000+ sites including:</p>
            <div class="sites-grid">
                <div class="site-tag">
                    <div class="platform-icon" style="background: #FF0000;">üì∫</div>
                    YouTube
                </div>
                <div class="site-tag">
                    <div class="platform-icon" style="background: #000000;">üéµ</div>
                    TikTok
                </div>
                <div class="site-tag">
                    <div class="platform-icon" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);">üì∏</div>
                    Instagram
                </div>
                <div class="site-tag">
                    <div class="platform-icon" style="background: #1DA1F2;">üê¶</div>
                    Twitter/X
                </div>
                <div class="site-tag">
                    <div class="platform-icon" style="background: #1877F2;">üë•</div>
                    Facebook
                </div>
                <div class="site-tag">
                    <div class="platform-icon" style="background: #FF6600;">üé¨</div>
                    Dailymotion
                </div>
            </div>
        </div>
    </div>

<script>
    class VideoDownloader {
        constructor() {
            this.ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}`);
            this.ws.onmessage = this.handleWebSocketMessage.bind(this);
            this.ws.onopen = () => console.log('WebSocket connected');
            this.ws.onclose = () => console.log('WebSocket disconnected');
            this.ws.onerror = (error) => console.error('WebSocket error:', error);
            this.form = document.getElementById('downloadForm');
            this.urlInput = document.getElementById('videoUrl');
            this.inputStatus = document.getElementById('inputStatus');
            this.videoPreview = document.getElementById('videoPreview');
            this.videoThumbnail = document.getElementById('videoThumbnail');
            this.videoTitle = document.getElementById('videoTitle');
            this.videoDuration = document.getElementById('videoDuration');
            this.videoUploader = document.getElementById('videoUploader');
            this.videoSize = document.getElementById('videoSize');
            this.formatSelect = document.getElementById('formatSelect');
            this.qualityGroup = document.getElementById('qualityGroup');
            this.downloadBtn = document.getElementById('downloadBtn');
            this.downloadText = document.getElementById('downloadText');
            this.progressContainer = document.getElementById('progressContainer');
            this.progressFill = document.getElementById('progressFill');
            this.statusText = document.getElementById('statusText');
            this.errorMessage = document.getElementById('errorMessage');
            this.successMessage = document.getElementById('successMessage');
            this.fileSizeEstimate = document.getElementById('fileSizeEstimate');
            this.estimatedSize = document.getElementById('estimatedSize');
            this.recentlyDownloaded = document.getElementById('recentlyDownloaded');
            this.recentList = document.getElementById('recentList');
            this.selectedQuality = '1080p';
            this.baseUrl = window.location.origin + '/api';
            this.currentVideoInfo = null;
            this.recentDownloads = this.loadRecentDownloads();
            this.recentDownloadsMemory = [];
            this.init();
        }
        
        handleWebSocketMessage(event) {
            const message = JSON.parse(event.data);
            console.log('Received message:', message);

            switch (message.type) {
                case 'status':
                    this.updateStatus(message.message);
                    this.updateProgress(message.percent);
                    break;
                case 'progress':
                    this.updateProgress(message.percent);
                    break;
                case 'error':
                    this.setLoading(false);
                    this.showProgress(false);
                    this.showError(message.message);
                    break;
                case 'download-ready':
                    this.updateProgress(100);
                    this.updateStatus('Download complete!');
                    
                    const a = document.createElement('a');
                    a.href = message.url;
                    a.download = message.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    this.addToRecentDownloads({
                        title: this.currentVideoInfo.title,
                        thumbnail: this.currentVideoInfo.thumbnail,
                        format: this.formatSelect.value,
                        quality: this.formatSelect.value.includes('mp') ? 'Audio' : this.selectedQuality,
                        size: this.formatFileSize(message.size),
                        timestamp: new Date()
                    });
                    
                    setTimeout(() => {
                        this.showSuccess(`‚úÖ Successfully downloaded: ${message.filename}`);
                        this.setLoading(false);
                        this.showProgress(false);
                    }, 1000);
                    break;
                }
            }

        init() {
            this.form.addEventListener('submit', this.handleSubmit.bind(this));
            this.formatSelect.addEventListener('change', this.updateFileSizeEstimate.bind(this));
            
            // Quality selection
            document.querySelectorAll('.quality-option').forEach(option => {
                option.addEventListener('click', () => {
                    if (option.classList.contains('disabled')) return;
                    
                    document.querySelectorAll('.quality-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    this.selectedQuality = option.dataset.quality;
                    this.updateFileSizeEstimate();
                });
            });

            // Check video info when URL changes
            this.urlInput.addEventListener('input', this.debounceVideoCheck.bind(this));
            this.urlInput.addEventListener('paste', () => {
                setTimeout(() => this.debounceVideoCheck(), 100);
            });

            this.displayRecentDownloads();
        }

        debounceVideoCheck() {
            clearTimeout(this.checkTimeout);
            this.hideMessages();
            this.hideVideoPreview();
            
            const url = this.urlInput.value.trim();
            
            if (!url) {
                this.resetDownloadButton();
                this.resetQualityButtons();
                this.setInputStatus('');
                return;
            }
            
            this.setInputStatus('‚è≥', 'checking');
            this.updateDownloadButton('Checking URL...', true);
            
            this.checkTimeout = setTimeout(() => {
                this.checkVideoInfo();
            }, 800);
        }

        async checkVideoInfo() {
            const url = this.urlInput.value.trim();
            if (!url) return;

            try {
                this.updateStatus('Checking video...');
                const response = await fetch(`${this.baseUrl}/video-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                if (!response.ok) {
                    throw new Error('Unable to access video');
                }

                const videoInfo = await response.json();
                this.currentVideoInfo = videoInfo;
                this.displayVideoPreview(videoInfo);
                this.disableUnavailableQualities(videoInfo.formats);
                this.updateFileSizeEstimate();
                this.setInputStatus('‚úì', 'valid');
                this.updateDownloadButton('Download Video', false);
                this.updateStatus('');

            } catch (error) {
                this.setInputStatus('‚ùå', 'invalid');
                this.showError('Unable to access video. Please verify the URL is correct and publicly accessible.');
                this.updateDownloadButton('Invalid URL', true);
                this.urlInput.classList.add('shake');
                setTimeout(() => this.urlInput.classList.remove('shake'), 500);
            }
        }

        displayVideoPreview(videoInfo) {
            this.videoThumbnail.src = videoInfo.thumbnail || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 90"><rect fill="%23ddd" width="160" height="90"/><text x="80" y="50" text-anchor="middle" fill="%23999">No thumbnail</text></svg>';
            this.videoTitle.textContent = videoInfo.title || 'Unknown Title';
            this.videoDuration.textContent = videoInfo.duration || 'Unknown';
            this.videoUploader.textContent = videoInfo.uploader || 'Unknown';
            
            // Calculate estimated original resolution
            const maxQuality = Math.max(...videoInfo.formats.filter(f => f.quality > 0).map(f => f.quality), 0);
            this.videoSize.textContent = maxQuality ? `${maxQuality}p max` : 'Audio only';
            
            this.videoPreview.classList.add('show');
        }

        hideVideoPreview() {
            this.videoPreview.classList.remove('show');
        }

        disableUnavailableQualities(formats) {
            const maxRes = Math.max(...formats.filter(f => f.quality > 0).map(f => f.quality), 0);
            const format = this.formatSelect.value;
            
            document.querySelectorAll('.quality-option').forEach(option => {
                const quality = option.dataset.quality;
                const height = parseInt(quality.replace('p', ''));
                
                // For audio formats, disable all video quality options
                if (format === 'mp3' || format === 'm4a') {
                    option.classList.add('disabled');
                    option.style.display = 'none';
                } else {
                    option.style.display = 'block';
                    if (height > maxRes && maxRes > 0) {
                        option.classList.add('disabled');
                    } else {
                        option.classList.remove('disabled');
                    }
                }
            });
            
            // Hide quality group for audio formats
            this.qualityGroup.style.display = (format === 'mp3' || format === 'm4a') ? 'none' : 'grid';
            
            // If selected quality is disabled, switch to highest available
            const selectedOption = document.querySelector('.quality-option.selected');
            if (selectedOption && selectedOption.classList.contains('disabled')) {
                this.resetToHighestAvailable(maxRes);
            }
        }

        resetToHighestAvailable(maxRes) {
            const qualities = ['4320p', '2160p', '1440p', '1080p', '720p', '480p'];
            
            for (const qual of qualities) {
                const height = parseInt(qual.replace('p', ''));
                if (height <= maxRes) {
                    const option = document.querySelector(`[data-quality="${qual}"]`);
                    if (option && !option.classList.contains('disabled')) {
                        document.querySelectorAll('.quality-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectedQuality = qual;
                        break;
                    }
                }
            }
        }

        updateFileSizeEstimate() {
            if (!this.currentVideoInfo) return;
            
            const format = this.formatSelect.value;
            const quality = this.selectedQuality;
            
            // Parse duration more reliably
            let duration = 300; // Default 5 minutes if unknown
            
            if (this.currentVideoInfo.duration && this.currentVideoInfo.duration !== 'Unknown') {
                const durationStr = this.currentVideoInfo.duration.toString();
                const parts = durationStr.split(':').map(p => parseInt(p) || 0);
                
                if (parts.length === 3) {
                    duration = parts[0] * 3600 + parts[1] * 60 + parts[2];
                } else if (parts.length === 2) {
                    duration = parts[0] * 60 + parts[1];
                } else if (parts.length === 1) {
                    duration = parts[0];
                }
            }
            
            let estimatedMB = 0;
            
            if (format === 'mp3') {
                // MP3: ~128kbps average
                estimatedMB = (duration * 128 * 1000) / (8 * 1024 * 1024);
            } else if (format === 'm4a') {
                // M4A: ~160kbps average  
                estimatedMB = (duration * 160 * 1000) / (8 * 1024 * 1024);
            } else {
                // Video formats - more accurate estimates based on resolution
                const height = parseInt(quality.replace('p', ''));
                let bitrateMbps;
                
                // Bitrate estimates based on modern encoding (H.264/H.265)
                if (height >= 4320) bitrateMbps = 40;      // 8K
                else if (height >= 2160) bitrateMbps = 15; // 4K  
                else if (height >= 1440) bitrateMbps = 8;  // 1440p
                else if (height >= 1080) bitrateMbps = 5;  // 1080p
                else if (height >= 720) bitrateMbps = 2.5; // 720p
                else bitrateMbps = 1;                      // 480p
                
                // Add audio bitrate (~128kbps)
                const totalBitrateMbps = bitrateMbps + 0.128;
                estimatedMB = (duration * totalBitrateMbps * 1000000) / (8 * 1024 * 1024);
            }
            
            // Format size display
            let sizeText;
            if (estimatedMB < 1024) {
                sizeText = `${Math.round(estimatedMB)} MB`;
            } else {
                sizeText = `${(estimatedMB / 1024).toFixed(1)} GB`;
            }
            
            // Add quality context
            const qualityContext = format === 'mp3' || format === 'm4a' ? 
                'Audio only' : 
                `${quality} video`;
                
            this.estimatedSize.textContent = `${sizeText} (${qualityContext})`;
            this.fileSizeEstimate.style.display = 'block';
        }

        setInputStatus(icon, status = '') {
            this.inputStatus.textContent = icon;
            this.urlInput.className = `url-input ${status}`;
        }

        resetDownloadButton() {
            this.updateDownloadButton('Enter URL to continue', true);
        }

        updateDownloadButton(text, disabled) {
            this.downloadText.textContent = text;
            this.downloadBtn.disabled = disabled;
            this.downloadBtn.classList.toggle('processing', !disabled && text.includes('Processing'));
        }

        resetQualityButtons() {
            document.querySelectorAll('.quality-option').forEach(option => {
                option.classList.remove('selected', 'disabled');
                option.style.display = 'block';
            });
            this.qualityGroup.style.display = 'grid';
            // Set default selection to 1080p
            const defaultOption = document.querySelector('[data-quality="1080p"]');
            if (defaultOption) {
                defaultOption.classList.add('selected');
                this.selectedQuality = '1080p';
            }
        }
        
        async handleSubmit(e) {
            e.preventDefault();
            
            const url = this.urlInput.value.trim();
            const format = this.formatSelect.value;
            
            if (!url || !this.currentVideoInfo) {
                this.showError('Please enter a valid video URL');
                return;
            }
            
            this.hideMessages();
            this.startDownload(url, format);
        }
        
        // New `startDownload` method
        async startDownload(url, format) {
            if (this.ws.readyState !== WebSocket.OPEN) {
                this.showError('Connection not open. Please refresh and try again.');
                return;
            }

            this.hideMessages();
            this.setLoading(true);
            this.showProgress(true);

            const requestPayload = {
                type: 'download-request',
                payload: {
                    url,
                    format,
                    quality: this.selectedQuality,
                },
            };

            this.ws.send(JSON.stringify(requestPayload));
        }

        formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        addToRecentDownloads(downloadInfo) {
            this.recentDownloads.unshift(downloadInfo);
            if (this.recentDownloads.length > 5) {
                this.recentDownloads = this.recentDownloads.slice(0, 5);
            }
            this.saveRecentDownloads();
            this.displayRecentDownloads();
        }

        loadRecentDownloads() {
            // In artifacts, we'll use in-memory storage
            return this.recentDownloadsMemory || [];
        }

        saveRecentDownloads() {
            // Store in memory since localStorage isn't available in artifacts
            this.recentDownloadsMemory = [...this.recentDownloads];
        }

        displayRecentDownloads() {
            if (this.recentDownloads.length === 0) {
                this.recentlyDownloaded.classList.remove('show');
                return;
            }

            this.recentList.innerHTML = this.recentDownloads.map(item => `
                <div class="recent-item">
                    <img class="recent-thumbnail" src="${item.thumbnail || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 34"><rect fill="%23ddd" width="60" height="34"/></svg>'}" alt="Thumbnail">
                    <div class="recent-details">
                        <div class="recent-title">${item.title.length > 40 ? item.title.substring(0, 40) + '...' : item.title}</div>
                        <div class="recent-meta">${item.format.toUpperCase()} ‚Ä¢ ${item.quality} ‚Ä¢ ${item.size}</div>
                    </div>
                </div>
            `).join('');
            
            this.recentlyDownloaded.classList.add('show');
        }
        
        showError(message) {
            this.errorMessage.textContent = message;
            this.errorMessage.style.display = 'block';
            this.errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        showSuccess(message) {
            this.successMessage.textContent = message;
            this.successMessage.style.display = 'block';
            this.successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        hideMessages() {
            this.errorMessage.style.display = 'none';
            this.successMessage.style.display = 'none';
            this.fileSizeEstimate.style.display = 'none';
        }

        setLoading(isLoading) {
            this.downloadBtn.disabled = isLoading;
            this.downloadBtn.classList.toggle('loading', isLoading);
            this.urlInput.disabled = isLoading;
            this.formatSelect.disabled = isLoading;
            
            if (isLoading) {
                this.updateDownloadButton('Processing...', true);
            }
        }

        showProgress(show) {
            this.progressContainer.style.display = show ? 'block' : 'none';
            if (!show) {
                this.updateProgress(0);
            }
        }

        updateProgress(percent) {
            this.progressFill.style.width = `${percent}%`;
        }

        updateStatus(text) {
            this.statusText.textContent = text;
        }
    }

    // Auto-focus on URL input when page loads
    document.addEventListener('DOMContentLoaded', () => {
        new VideoDownloader();
        document.getElementById('videoUrl').focus();
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + V to focus URL input
        if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
            const urlInput = document.getElementById('videoUrl');
            if (document.activeElement !== urlInput) {
                urlInput.focus();
            }
        }
        
        // Enter to download if form is valid
        if (e.key === 'Enter' && !e.shiftKey) {
            const downloadBtn = document.getElementById('downloadBtn');
            if (!downloadBtn.disabled && document.activeElement !== downloadBtn) {
                e.preventDefault();
                downloadBtn.click();
            }
        }
    });
</script>
</body>
</html>